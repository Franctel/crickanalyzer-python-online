{% if shottype_report and shottype_report.chart_data %}
<div class="card">
    <div class="card-body" id="shottype-content">
        <h6 class="mb-4 text-15">Shot Type Report</h6>

        <!-- Main Bar Chart -->
        <div id="shottype-bar-chart" class="apex-charts" 
             data-chart-data='{{ shottype_report.chart_data | tojson | safe }}'></div>

        <!-- Filter Buttons -->
        <div id="shottype-filters" class="flex flex-wrap items-center gap-2 my-4">
            <!-- Filter buttons will be injected here by JavaScript -->
        </div>

        <!-- Striker-wise Tables -->
        <div id="strikers-container-shottype">
        {% if shottype_report.strikers_data %}
            {% for striker, table_data in shottype_report.strikers_data.items() %}
            {% set total_runs = table_data | sum(attribute='runs') %}
            <div class="striker-card-shottype mt-6" data-striker="{{ striker }}" data-total-runs="{{ total_runs }}">
                <h6 class="mb-4 text-15 font-semibold">{{ striker }}</h6>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs text-left rtl:text-right whitespace-nowrap">
                        <thead class="border-b border-slate-200 dark:border-zink-500">
                            <tr>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">Shot Type</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">Runs</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">4s</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">6s</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">1s</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">2s</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">Strike Rate</th>
                                <th class="px-3.5 py-2.5 font-semibold text-slate-500 dark:text-zink-200">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in table_data %}
                            <tr data-shot-type="{{ row.shot_type }}">
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    {{ row.shot_type }}
                                </td>

                                <!-- Runs -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    <div class="shot-bar-shottype w-20 h-4" 
                                         data-type="runs"
                                         data-chart-data='{{ {"series":[{"data":[row.runs]}]} | tojson | safe }}'></div>
                                </td>

                                <!-- 4s -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    <div class="shot-bar-shottype w-16 h-4" 
                                         data-type="fours"
                                         data-chart-data='{{ {"series":[{"data":[row.fours]}]} | tojson | safe }}'></div>
                                </td>

                                <!-- 6s -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    <div class="shot-bar-shottype w-16 h-4" 
                                         data-type="sixes"
                                         data-chart-data='{{ {"series":[{"data":[row.sixes]}]} | tojson | safe }}'></div>
                                </td>

                                <!-- 1s -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    <div class="shot-bar-shottype w-16 h-4" 
                                         data-type="ones"
                                         data-chart-data='{{ {"series":[{"data":[row.ones]}]} | tojson | safe }}'></div>
                                </td>

                                <!-- 2s -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    <div class="shot-bar-shottype w-16 h-4" 
                                         data-type="twos"
                                         data-chart-data='{{ {"series":[{"data":[row.twos]}]} | tojson | safe }}'></div>
                                </td>

                                <!-- Strike Rate -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    {{ row.strike_rate }}
                                </td>

                                <!-- Actions -->
                                <td class="px-3.5 py-2.5 border-y border-slate-200 dark:border-zink-500">
                                    {% if row.video_urls %}
                                    <button class="p-1 text-xs font-medium rounded-md bg-green-500 text-white play-video-btn" 
                                            data-videos='{{ row.video_urls | tojson }}' 
                                            data-tailwind-url="{{ url_for('static', filename='css/tailwind.css') }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" 
                                             viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
                                             class="lucide lucide-play">
                                             <polygon points="5 3 19 12 5 21 5 3"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <p class="mt-6 text-center text-slate-600 dark:text-zink-200">No detailed shottype data available.</p>
        {% endif %}
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body">
        <p class="text-center text-slate-600 dark:text-zink-200">No Shot Type data available for the selected filters.</p>
    </div>
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    // --- Sorting Striker Cards ---
    const strikersContainer = document.getElementById('strikers-container-shottype');
    if (strikersContainer) {
        const strikerCards = Array.from(strikersContainer.getElementsByClassName('striker-card-shottype'));
        strikerCards.sort((a, b) => (parseInt(b.dataset.totalRuns, 10) || 0) - (parseInt(a.dataset.totalRuns, 10) || 0));
        strikerCards.forEach(card => strikersContainer.appendChild(card));
    }

    // --- Chart and Filter Logic ---
    const filtersContainer = document.getElementById('shottype-filters');
    const mainChartEl = document.getElementById('shottype-bar-chart');

    if (!filtersContainer || !mainChartEl) {
        return;
    }

    try {
        // --- Generate Filter Buttons ---
        const mainChartData = JSON.parse(mainChartEl.dataset.chartData);
        const shotTypes = mainChartData.labels || [];
        let buttonsHTML = '<button data-filter="all" class="shottype-filter-btn active-filter px-3 py-1 text-xs font-medium rounded-md bg-custom-500 text-white">All</button>';
        shotTypes.forEach(shotType => {
            buttonsHTML += `<button data-filter="${shotType}" class="shottype-filter-btn px-3 py-1 text-xs font-medium rounded-md bg-slate-100 text-slate-700 dark:bg-zink-600 dark:text-zink-100">${shotType}</button>`;
        });
        filtersContainer.innerHTML = buttonsHTML;

        // --- Filter Event Listener ---
        filtersContainer.addEventListener('click', function(event) {
            const button = event.target.closest('.shottype-filter-btn');
            if (!button) return;

            // Update button styles
            filtersContainer.querySelectorAll('.shottype-filter-btn').forEach(btn => {
                btn.classList.remove('active-filter', 'bg-custom-500', 'text-white');
                btn.classList.add('bg-slate-100', 'text-slate-700', 'dark:bg-zink-600', 'dark:text-zink-100');
            });
            button.classList.add('active-filter', 'bg-custom-500', 'text-white');
            button.classList.remove('bg-slate-100', 'text-slate-700', 'dark:bg-zink-600', 'dark:text-zink-100');
            
            const filter = button.dataset.filter;
            
            // Process filtering
            document.querySelectorAll('.striker-card-shottype').forEach(card => {
                let hasVisibleRows = false;
                card.querySelectorAll('tbody tr').forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                        hasVisibleRows = true;
                    } else {
                        const shotType = row.dataset.shotType;
                        if (shotType === filter) {
                            row.style.display = '';
                            hasVisibleRows = true;
                        } else {
                            row.style.display = 'none';
                        }
                    }
                });
                card.style.display = hasVisibleRows ? '' : 'none';
            });
        });

    } catch (e) {
        console.error("Error setting up shottype filters:", e);
    }

    // --- Chart Rendering for Shot Type ---
    const colorsMap = {
        ones: "rgba(59,130,246,0.7)", 
        twos: "rgba(139,92,246,0.7)",
        fours: "rgba(34,197,94,0.7)", 
        sixes: "rgba(239,68,68,0.7)",
        runs: "rgba(234,179,8,0.7)"
    };

    try {
        const chartData = JSON.parse(mainChartEl.dataset.chartData);

        // ✅ Dynamic height like Areawise
        const dynamicHeight = Math.max(400, (chartData.labels?.length || 0) * 35);

        const mainChartOptions = {
            chart: { 
                type: "bar", 
                height: dynamicHeight,  // ✅ same scaling as Areawise
                stacked: true,
                toolbar: { show: true },
                background: "transparent",
                animations: { enabled: true, easing: "easeinout", speed: 700 }
            },
            plotOptions: { 
                bar: { 
                    horizontal: true, 
                    barHeight: "65%",
                    dataLabels: { position: "center" } 
                } 
            },
            dataLabels: { 
                enabled: true, 
                style: { colors: ["#fff"], fontSize: "13px", fontWeight: "bold" }, 
                formatter: (val) => val > 0 ? val : ""
            },
            colors: ["#1E90FF", "#FF6347", "#32CD32", "#FFD700"], 
            series: chartData.series || [], 
            xaxis: { 
                categories: chartData.labels || [],
                title: { text: "Runs", style: { fontSize: "14px", fontWeight: 600 } },
                labels: { style: { fontSize: "12px", colors: "#374151" } }
            },
            yaxis: { 
                title: { text: "Shot Type", style: { fontSize: "14px", fontWeight: 600 } },
                labels: { style: { fontSize: "12px", colors: "#374151" } }
            },
            tooltip: { 
                shared: true, 
                intersect: false, 
                y: { formatter: (val) => val + " runs" }
            },
            grid: { show: false },
            title: { text: "Shot Type Report", align: "center" },
            legend: { position: "top" }
        };

        const chart = new ApexCharts(mainChartEl, mainChartOptions);
        chart.render();

        // ✅ Save globally so switchTab() can resize later
        window.shottypeChart = chart;

        // ✅ Resize after render (fix hidden tab congestion)
        setTimeout(() => {
            chart.resize();
        }, 500);

    } catch (e) { 
        console.error("Error rendering Shot Type chart", e);
    }


    // --- Lazy Load Inline Charts ---
    const lazyRenderChart = (entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const el = entry.target;
                try {
                    const chartData = JSON.parse(el.dataset.chartData);
                    const type = el.dataset.type;
                    new ApexCharts(el, {
                        chart: { type: "bar", height: 24, sparkline: { enabled: true } },
                        plotOptions: { bar: { horizontal: true, columnWidth: "80%", dataLabels: { position: "center" } } },
                        colors: [colorsMap[type] || "rgba(100,100,100,0.6)"], series: chartData.series,
                        dataLabels: { enabled: true, formatter: (val) => val, style: { colors: ["#fff"], fontSize: "10px", fontWeight: "bold" } },
                        tooltip: { enabled: false },
                        xaxis: { labels: { show: false }, axisBorder: { show: false }, axisTicks: { show: false } },
                        yaxis: { labels: { show: false } }
                    }).render();
                } catch (e) { console.error("Error rendering shot-bar", e); }
                observer.unobserve(el);
            }
        });
    };

    const observer = new IntersectionObserver(lazyRenderChart, {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
    });

    document.querySelectorAll(".shot-bar-shottype").forEach(el => observer.observe(el));
});
</script>
